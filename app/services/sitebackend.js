"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var site_1 = require("./site");
var observable_array_1 = require("data/observable-array");
var file_system_1 = require("file-system");
var cryptoservice_1 = require("./cryptoservice");
var Sqlite = require("nativescript-sqlite");
var SiteBackend;
(function (SiteBackend) {
    function Initialize() {
        return new Promise(function (resolve, reject) {
            var sentence = "CREATE TABLE Site (\n                            Id INTEGER PRIMARY KEY AUTOINCREMENT,\n                            LastChange NUMERIC NOT NULL,\n                            InSync NUMERIC NOT NULL,\n                            Name TEXT NOT NULL,\n                            Url\tTEXT NOT NULL,\n                            User TEXT,\n                            Password TEXT,\n                            Tags TEXT);";
            (new Sqlite("guaysin.db")).then(function (db) {
                db.execSQL(sentence).then(function (id) {
                    db.close();
                    resolve();
                }, function (error) {
                    reject(error);
                });
            }, function (error) {
                reject(error);
            });
        });
    }
    SiteBackend.Initialize = Initialize;
    function LoadSites(filter) {
        var sentence = "SELECT * FROM Site";
        var data = new observable_array_1.ObservableArray();
        var regexp;
        if (filter)
            regexp = new RegExp(".*" + filter + ".*");
        (new Sqlite("guaysin.db")).then(function (db) {
            db.all(sentence).then(function (rows) {
                for (var row in rows) {
                    var r = rows[row];
                    //let site = new Site(r[3],r[4],r[5],r[6],r[0]);
                    var site = new site_1.Site(cryptoservice_1.CryptoServices.Decode(r[3]), cryptoservice_1.CryptoServices.Decode(r[4]), cryptoservice_1.CryptoServices.Decode(r[5]), cryptoservice_1.CryptoServices.Decode(r[6]), r[0]);
                    if (regexp) {
                        if (regexp.test(site.Name))
                            data.push(site);
                    }
                    else {
                        data.push(site);
                    }
                }
                db.close();
            }, function (error) {
                throw new Error(error.message);
            });
        });
        return data;
    }
    SiteBackend.LoadSites = LoadSites;
    function SaveSite(site) {
        return new Promise(function (resolve, reject) {
            var sentence;
            if (site.Id == undefined) {
                sentence = "INSERT INTO Site (LastChange, InSync, Name, Url, User, Password) VALUES (?,?,?,?,?,?);";
            }
            else {
                sentence = "UPDATE Site SET LastChange=?,InSync=?,Name=?,Url=?,User=?,Password=? WHERE Id=" + site.Id + ";";
            }
            var params = [1, 2,
                cryptoservice_1.CryptoServices.Encode(site.Name),
                cryptoservice_1.CryptoServices.Encode(site.Url),
                cryptoservice_1.CryptoServices.Encode(site.User),
                cryptoservice_1.CryptoServices.Encode(site.Password)
            ];
            (new Sqlite("guaysin.db")).then(function (db) {
                db.execSQL(sentence, params).then(function (id) {
                    db.close();
                    resolve();
                }, function (error) {
                    reject(error);
                });
            }, function (error) {
                reject(error);
            });
        });
    }
    SiteBackend.SaveSite = SaveSite;
    function DeleteSite(site) {
        return new Promise(function (resolve, reject) {
            if (site.Id != undefined) {
                var sentence_1 = "DELETE FROM Site WHERE Id=" + site.Id + ";";
                (new Sqlite("guaysin.db")).then(function (db) {
                    db.execSQL(sentence_1).then(function (id) {
                        db.close();
                        resolve();
                    }, function (error) {
                        reject(error);
                    });
                }, function (error) {
                    reject(error);
                });
            }
        });
    }
    SiteBackend.DeleteSite = DeleteSite;
    function CleanSites() {
        return new Promise(function (resolve, reject) {
            var sentence = "DELETE FROM Site;";
            (new Sqlite("guaysin.db")).then(function (db) {
                db.execSQL(sentence).then(function (id) {
                    db.close();
                    resolve();
                }, function (error) {
                    reject(error);
                });
            }, function (error) {
                reject(error);
            });
        });
    }
    function GetBackupFile() {
        var downloadsFolderPath = file_system_1.path.join(android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_DOWNLOADS).getAbsolutePath().toString());
        var downloadsFolder = file_system_1.Folder.fromPath(downloadsFolderPath);
        var file = downloadsFolder.getFile("guaysindata.json");
        return file;
    }
    function ExportToFile() {
        var sentence = "SELECT * FROM Site";
        return new Promise(function (resolve, reject) {
            //get all sites and create array
            (new Sqlite("guaysin.db")).then(function (db) {
                db.all(sentence).then(function (rows) {
                    var data = [];
                    for (var row in rows) {
                        var r = rows[row];
                        var site = new site_1.Site(cryptoservice_1.CryptoServices.Decode(r[3]), cryptoservice_1.CryptoServices.Decode(r[4]), cryptoservice_1.CryptoServices.Decode(r[5]), cryptoservice_1.CryptoServices.Decode(r[6]), r[0]);
                        data.push(site);
                    }
                    db.close();
                    //let secret:string = CryptoServices.GetEncryptedSecret();
                    //let payload = {'secret':secret,'sites':data};
                    //prepare target file
                    var file = GetBackupFile();
                    //save and return
                    file.writeText(JSON.stringify(data)).then(function () {
                        resolve();
                    }, function (error) {
                        reject(error);
                    });
                }, function (error) {
                    reject(error);
                });
            });
        });
    }
    SiteBackend.ExportToFile = ExportToFile;
    function ImportFromFile() {
        return new Promise(function (resolve, reject) {
            var file = GetBackupFile();
            //1.Read JSON file
            file.readText().then(function (jsondata) {
                //let data = JSON.parse(jsondata);
                //let secret:string = data.secret;
                var sites = JSON.parse(jsondata);
                //2.Clean DB
                CleanSites().then(function () {
                    //3.Insert sites
                    sites.forEach(function (site) {
                        site.Id = undefined;
                        SaveSite(site);
                    });
                    resolve();
                });
            });
        });
    }
    SiteBackend.ImportFromFile = ImportFromFile;
})(SiteBackend = exports.SiteBackend || (exports.SiteBackend = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2l0ZWJhY2tlbmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzaXRlYmFja2VuZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUE0QjtBQUM1QiwwREFBc0Q7QUFDdEQsMkNBQTZDO0FBQzdDLGlEQUErQztBQUMvQyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUU1QyxJQUFjLFdBQVcsQ0E4THhCO0FBOUxELFdBQWMsV0FBVztJQUVyQjtRQUNJLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBTSxVQUFDLE9BQU8sRUFBQyxNQUFNO1lBQ25DLElBQUksUUFBUSxHQUFHLHVhQVFhLENBQUM7WUFFN0IsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLEVBQUU7Z0JBQzFCLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsRUFBRTtvQkFDeEIsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO29CQUNYLE9BQU8sRUFBRSxDQUFDO2dCQUNkLENBQUMsRUFBQyxVQUFBLEtBQUs7b0JBQ0gsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNsQixDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsRUFBRSxVQUFBLEtBQUs7Z0JBQ0osTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xCLENBQUMsQ0FBQyxDQUFDO1FBQ1gsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBdkJlLHNCQUFVLGFBdUJ6QixDQUFBO0lBRUQsbUJBQTBCLE1BQWE7UUFDbkMsSUFBSSxRQUFRLEdBQUcsb0JBQW9CLENBQUM7UUFDcEMsSUFBSSxJQUFJLEdBQUcsSUFBSSxrQ0FBZSxFQUFRLENBQUM7UUFDdkMsSUFBSSxNQUFhLENBQUM7UUFDbEIsRUFBRSxDQUFBLENBQUMsTUFBTSxDQUFDO1lBQ04sTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLE9B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LGFBQWEsRUFBRSxDQUFDO1lBQzNCLGtCQUFrQjtZQUNsQixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUMsUUFBUTtnQkFDMUIsa0NBQWtDO2dCQUNsQyxrQ0FBa0M7Z0JBQ2xDLElBQUksS0FBSyxHQUFVLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3hDLFlBQVk7Z0JBQ1osVUFBVSxFQUFFLENBQUMsSUFBSSxDQUFDO29CQUNkLGdCQUFnQjtvQkFDaEIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQUk7d0JBQ2YsSUFBSSxDQUFDLEVBQUUsR0FBRyxTQUFTLENBQUM7d0JBQ3BCLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDbkIsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsT0FBTyxFQUFFLENBQUM7Z0JBQ2QsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQW5CZSwwQkFBYyxpQkFtQjdCLENBQUE7QUFDTCxDQUFDLEVBOUxhLFdBQVcsR0FBWCxtQkFBVyxLQUFYLG1CQUFXLFFBOEx4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7U2l0ZX0gZnJvbSBcIi4vc2l0ZVwiO1xuaW1wb3J0IHtPYnNlcnZhYmxlQXJyYXl9IGZyb20gXCJkYXRhL29ic2VydmFibGUtYXJyYXlcIjtcbmltcG9ydCB7RmlsZSxGb2xkZXIscGF0aH0gZnJvbSBcImZpbGUtc3lzdGVtXCI7XG5pbXBvcnQge0NyeXB0b1NlcnZpY2VzfSBmcm9tIFwiLi9jcnlwdG9zZXJ2aWNlXCI7XG52YXIgU3FsaXRlID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC1zcWxpdGVcIik7XG5cbmV4cG9ydCBtb2R1bGUgU2l0ZUJhY2tlbmR7XG4gICAgICAgICAgICAgICAgICBcbiAgICBleHBvcnQgZnVuY3Rpb24gSW5pdGlhbGl6ZSgpOlByb21pc2U8YW55PntcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUscmVqZWN0KSA9PntcbiAgICAgICAgICAgIHZhciBzZW50ZW5jZSA9IGBDUkVBVEUgVEFCTEUgU2l0ZSAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgSWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIExhc3RDaGFuZ2UgTlVNRVJJQyBOT1QgTlVMTCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBJblN5bmMgTlVNRVJJQyBOT1QgTlVMTCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBOYW1lIFRFWFQgTk9UIE5VTEwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVXJsXHRURVhUIE5PVCBOVUxMLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVzZXIgVEVYVCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBQYXNzd29yZCBURVhULFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRhZ3MgVEVYVCk7YDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIChuZXcgU3FsaXRlKFwiZ3VheXNpbi5kYlwiKSkudGhlbihkYiA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGRiLmV4ZWNTUUwoc2VudGVuY2UpLnRoZW4oaWQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGIuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSxlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICAgICAgfSk7ICAgICBcbiAgICAgICAgfSk7ICAgICAgICAgICAgICAgICAgICAgICBcbiAgICB9XG4gICAgICAgXG4gICAgZXhwb3J0IGZ1bmN0aW9uIExvYWRTaXRlcyhmaWx0ZXI6c3RyaW5nKTpPYnNlcnZhYmxlQXJyYXk8U2l0ZT57XG4gICAgICAgIGxldCBzZW50ZW5jZSA9IFwiU0VMRUNUICogRlJPTSBTaXRlXCI7XG4gICAgICAgIGxldCBkYXRhID0gbmV3IE9ic2VydmFibGVBcnJheTxTaXRlPigpO1xuICAgICAgICBsZXQgcmVnZXhwOlJlZ0V4cDtcbiAgICAgICAgaWYoZmlsdGVyKVxuICAgICAgICAgICAgcmVnZXhwID0gbmV3IFJlZ0V4cChgLioke2ZpbHRlcn0uKmApO1xuICAgICAgICAgICAgXG4gICAgICAgIChuZXcgU3FsaXRlKFwiZ3VheXNpbi5kYlwiKSkudGhlbihkYiA9PiB7XG4gICAgICAgICAgICBkYi5hbGwoc2VudGVuY2UpLnRoZW4ocm93cyA9PiB7XG4gICAgICAgICAgICAgICAgZm9yKGxldCByb3cgaW4gcm93cykge1xuICAgICAgICAgICAgICAgICAgICBsZXQgcj1yb3dzW3Jvd107XG4gICAgICAgICAgICAgICAgICAgIC8vbGV0IHNpdGUgPSBuZXcgU2l0ZShyWzNdLHJbNF0scls1XSxyWzZdLHJbMF0pO1xuICAgICAgICAgICAgICAgICAgICBsZXQgc2l0ZSA9IG5ldyBTaXRlKENyeXB0b1NlcnZpY2VzLkRlY29kZShyWzNdKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDcnlwdG9TZXJ2aWNlcy5EZWNvZGUocls0XSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ3J5cHRvU2VydmljZXMuRGVjb2RlKHJbNV0pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENyeXB0b1NlcnZpY2VzLkRlY29kZShyWzZdKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgaWYocmVnZXhwKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlZ2V4cC50ZXN0KHNpdGUuTmFtZSkpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHNpdGUpO1xuICAgICAgICAgICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEucHVzaChzaXRlKTsgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgfSxlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gICAgXG4gICAgZXhwb3J0IGZ1bmN0aW9uIFNhdmVTaXRlKHNpdGU6U2l0ZSk6UHJvbWlzZTxhbnk+e1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSxyZWplY3QpPT57XG4gICAgICAgICAgICBsZXQgc2VudGVuY2U6c3RyaW5nO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZihzaXRlLklkPT11bmRlZmluZWQpe1xuICAgICAgICAgICAgICAgIHNlbnRlbmNlID0gXCJJTlNFUlQgSU5UTyBTaXRlIChMYXN0Q2hhbmdlLCBJblN5bmMsIE5hbWUsIFVybCwgVXNlciwgUGFzc3dvcmQpIFZBTFVFUyAoPyw/LD8sPyw/LD8pO1wiOyAgICBcbiAgICAgICAgICAgIH1lbHNle1xuICAgICAgICAgICAgICAgIHNlbnRlbmNlID0gYFVQREFURSBTaXRlIFNFVCBMYXN0Q2hhbmdlPT8sSW5TeW5jPT8sTmFtZT0/LFVybD0/LFVzZXI9PyxQYXNzd29yZD0/IFdIRVJFIElkPSR7c2l0ZS5JZH07YDsgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcGFyYW1zID0gWyAgMSwyLCAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgQ3J5cHRvU2VydmljZXMuRW5jb2RlKHNpdGUuTmFtZSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgQ3J5cHRvU2VydmljZXMuRW5jb2RlKHNpdGUuVXJsKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDcnlwdG9TZXJ2aWNlcy5FbmNvZGUoc2l0ZS5Vc2VyKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDcnlwdG9TZXJ2aWNlcy5FbmNvZGUoc2l0ZS5QYXNzd29yZClcbiAgICAgICAgICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIChuZXcgU3FsaXRlKFwiZ3VheXNpbi5kYlwiKSkudGhlbihkYiA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGRiLmV4ZWNTUUwoc2VudGVuY2UsIHBhcmFtcykudGhlbihpZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9KTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSxlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9KTsgXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBleHBvcnQgZnVuY3Rpb24gRGVsZXRlU2l0ZShzaXRlOlNpdGUpOlByb21pc2U8YW55PntcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUscmVqZWN0KT0+e1xuICAgICAgICAgICAgaWYoc2l0ZS5JZCE9dW5kZWZpbmVkKXtcbiAgICAgICAgICAgICAgICBsZXQgc2VudGVuY2UgPSBgREVMRVRFIEZST00gU2l0ZSBXSEVSRSBJZD0ke3NpdGUuSWR9O2A7XG4gICAgICAgICAgICAgICAgKG5ldyBTcWxpdGUoXCJndWF5c2luLmRiXCIpKS50aGVuKGRiID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZGIuZXhlY1NRTChzZW50ZW5jZSkudGhlbihpZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkYi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9LCBlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9KTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9LGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICB9KTsgICAgICAgICAgICAgXG4gICAgICAgICAgICB9IFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBDbGVhblNpdGVzKCk6UHJvbWlzZTxhbnk+e1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSxyZWplY3QpPT57XG4gICAgICAgICAgICBsZXQgc2VudGVuY2UgPSBgREVMRVRFIEZST00gU2l0ZTtgO1xuICAgICAgICAgICAgKG5ldyBTcWxpdGUoXCJndWF5c2luLmRiXCIpKS50aGVuKGRiID0+IHtcbiAgICAgICAgICAgICAgICBkYi5leGVjU1FMKHNlbnRlbmNlKS50aGVuKGlkID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZGIuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICB9KTsgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9LGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfSk7ICAgICAgICAgICAgICBcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gR2V0QmFja3VwRmlsZSgpOkZpbGV7XG4gICAgICAgIGxldCBkb3dubG9hZHNGb2xkZXJQYXRoID0gcGF0aC5qb2luKGFuZHJvaWQub3MuRW52aXJvbm1lbnQuZ2V0RXh0ZXJuYWxTdG9yYWdlUHVibGljRGlyZWN0b3J5KGFuZHJvaWQub3MuRW52aXJvbm1lbnQuRElSRUNUT1JZX0RPV05MT0FEUykuZ2V0QWJzb2x1dGVQYXRoKCkudG9TdHJpbmcoKSk7XG4gICAgICAgIGxldCBkb3dubG9hZHNGb2xkZXIgPSBGb2xkZXIuZnJvbVBhdGgoZG93bmxvYWRzRm9sZGVyUGF0aCk7XG4gICAgICAgIGxldCBmaWxlID0gZG93bmxvYWRzRm9sZGVyLmdldEZpbGUoXCJndWF5c2luZGF0YS5qc29uXCIpO1xuICAgICAgICByZXR1cm4gZmlsZTsgICAgICAgIFxuICAgIH1cblxuICAgIGV4cG9ydCBmdW5jdGlvbiBFeHBvcnRUb0ZpbGUoKTpQcm9taXNlPGFueT57XG4gICAgICAgIGxldCBzZW50ZW5jZSA9IFwiU0VMRUNUICogRlJPTSBTaXRlXCI7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUscmVqZWN0KSA9PntcbiAgICAgICAgICAgIC8vZ2V0IGFsbCBzaXRlcyBhbmQgY3JlYXRlIGFycmF5XG4gICAgICAgICAgICAobmV3IFNxbGl0ZShcImd1YXlzaW4uZGJcIikpLnRoZW4oZGIgPT4ge1xuICAgICAgICAgICAgICAgIGRiLmFsbChzZW50ZW5jZSkudGhlbihyb3dzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGE6IFNpdGVbXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBmb3IobGV0IHJvdyBpbiByb3dzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgcj1yb3dzW3Jvd107XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2l0ZSA9IG5ldyBTaXRlKENyeXB0b1NlcnZpY2VzLkRlY29kZShyWzNdKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ3J5cHRvU2VydmljZXMuRGVjb2RlKHJbNF0pLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBDcnlwdG9TZXJ2aWNlcy5EZWNvZGUocls1XSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENyeXB0b1NlcnZpY2VzLkRlY29kZShyWzZdKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgclswXSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5wdXNoKHNpdGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgZGIuY2xvc2UoKTtcblxuICAgICAgICAgICAgICAgICAgICAvL2xldCBzZWNyZXQ6c3RyaW5nID0gQ3J5cHRvU2VydmljZXMuR2V0RW5jcnlwdGVkU2VjcmV0KCk7XG4gICAgICAgICAgICAgICAgICAgIC8vbGV0IHBheWxvYWQgPSB7J3NlY3JldCc6c2VjcmV0LCdzaXRlcyc6ZGF0YX07XG5cbiAgICAgICAgICAgICAgICAgICAgLy9wcmVwYXJlIHRhcmdldCBmaWxlXG4gICAgICAgICAgICAgICAgICAgIGxldCBmaWxlID0gR2V0QmFja3VwRmlsZSgpO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vc2F2ZSBhbmQgcmV0dXJuXG4gICAgICAgICAgICAgICAgICAgIGZpbGUud3JpdGVUZXh0KEpTT04uc3RyaW5naWZ5KGRhdGEpKS50aGVuKCgpID0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9LGVycm9yID0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfSkgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSxlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pOyAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIH0pOyAgICAgICAgXG4gICAgfVxuXG4gICAgZXhwb3J0IGZ1bmN0aW9uIEltcG9ydEZyb21GaWxlKCk6UHJvbWlzZTxhbnk+e1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSxyZWplY3QpPT57XG4gICAgICAgICAgICBsZXQgZmlsZSA9IEdldEJhY2t1cEZpbGUoKTtcbiAgICAgICAgICAgIC8vMS5SZWFkIEpTT04gZmlsZVxuICAgICAgICAgICAgZmlsZS5yZWFkVGV4dCgpLnRoZW4oKGpzb25kYXRhKT0+e1xuICAgICAgICAgICAgICAgIC8vbGV0IGRhdGEgPSBKU09OLnBhcnNlKGpzb25kYXRhKTtcbiAgICAgICAgICAgICAgICAvL2xldCBzZWNyZXQ6c3RyaW5nID0gZGF0YS5zZWNyZXQ7XG4gICAgICAgICAgICAgICAgbGV0IHNpdGVzOlNpdGVbXSA9IEpTT04ucGFyc2UoanNvbmRhdGEpO1xuICAgICAgICAgICAgICAgIC8vMi5DbGVhbiBEQlxuICAgICAgICAgICAgICAgIENsZWFuU2l0ZXMoKS50aGVuKCgpPT57XG4gICAgICAgICAgICAgICAgICAgIC8vMy5JbnNlcnQgc2l0ZXNcbiAgICAgICAgICAgICAgICAgICAgc2l0ZXMuZm9yRWFjaCgoc2l0ZSk9PntcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpdGUuSWQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBTYXZlU2l0ZShzaXRlKTsgICAgXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSAgICAgICBcbn1cbiJdfQ==